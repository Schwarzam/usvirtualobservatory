#! /bin/bash

# get a credential from the MyProxy server.
usage() {
    echo "Usage: $0 <username> <credential_file> < <pwd-on-stdin>"
    exit 1
}

if [ "$2" = "" -o "$3" != "" ]; then
    usage
    exit 1
fi

USERNAME=$1
CREDFILE=$2

/bin/rm -f /tmp/t5 /tmp/t6

# echo "CALLING myproxy-server" >> /tmp/t5

export MYPROXY_SERVER_DN="@myproxy.server.dn@"
CMD="@myproxy.logon.cmd@ -s localhost -l $USERNAME -o $CREDFILE"
echo $CMD >> /tmp/t5
AUTH_OUT=`$CMD` < /dev/stdin
#eval $CMD < /dev/stdin
#echo $AUTH_OUT
AUTH_SUCCESS=$?

if [ $AUTH_SUCCESS = 0 ]; then
    /bin/chmod 640 $CREDFILE
    echo "REAL CRED CREATED in $CREDFILE" >> /tmp/t5
    exit 0;
else
    echo $AUTH_OUT
    echo "$AUTH_OUT" >> /tmp/t6
    exit $AUTH_SUCCESS
fi

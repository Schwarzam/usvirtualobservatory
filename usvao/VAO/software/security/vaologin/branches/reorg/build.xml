<?xml version="1.0"?>
<project name="vaologin" default="dist" basedir=".">

  <import file="build-layout.xml" as="lo"/>
  <property name="pkg.name" value="vaologin"/>
  <property name="pkg.version" value="1.0pre"/>
  <property name="debug" value="true"/>

  <property name="target.jar" value="${pkg.name}-${pkg.version}.jar"/>
  <property name="target.jar.path" value="${dir.lib}/${target.jar}"/>

  <path id="classpath.build">
    <pathelement location="${dir.build.classes}" />
    <path refid="local.jar.path"/>
  </path>
  <path id="classpath.test">
    <pathelement location="${dir.test.classes}" />
    <path refid="classpath.build"/>
    <pathelement location="${target.jar.path}" />
  </path>

  <property name="dir.ptest" value="${dir.test}/python"/>
  <property name="dir.plib" value="${dir.lib}/python"/>
  <pathconvert property="pythonpath">
    <path>
      <pathelement location="${dir.plib}"/>
      <fileset dir="${dir.lib}" includes="*.egg"/>
    </path>
  </pathconvert>

  <condition property="python.exe" value="python.exe">
    <os family="windows" />
  </condition>
  <property name="python.exe" value="python" />

  <target name="init" depends="lo.initOutputDirs">
    <mkdir dir="${dir.etc}"/>
  </target>

  <target name="init-tests" depends="init">
    <mkdir dir="${dir.test.classes}"/>
    <mkdir dir="${dir.testreport}"/>
  </target>

  <target name="compile" depends="build-python,compile-java"/>

  <target name="build" depends="build-java,build-python"/>

  <target name="build-java" depends="jar"/>

  <target name="build-python">
    <exec executable="${python.exe}">
      <arg line="setup.py build"/>
    </exec>
  </target>

  <target name="compile-java" depends="init">
    <javac srcdir="${dir.src.java}" destdir="${dir.build.classes}" 
           debug="${debug}" classpathref="classpath.build" deprecation="on"
           optimize="off" source="1.5" includeantruntime="false"/>
    <copy todir="${dir.build.classes}">
      <fileset dir="${dir.src}">
        <include name="**/*.properties"/>
      </fileset>
    </copy>
  </target>

  <target name="jar" depends="compile-java">
    <jar jarfile="${target.jar.path}" basedir="${dir.build.classes}" />
  </target>

  <target name="test" depends="test-python" />

  <target name="compile-java-tests" depends="init-tests,compile-java">
    <javac srcdir="${dir.test.src.java}" destdir="${dir.test.classes}" 
           debug="${debug}" classpathref="classpath.build" deprecation="on"
           optimize="off" source="1.5" includeantruntime="true"/>
    <copy todir="${dir.test.classes}">
      <fileset dir="${dir.test.src.java}">
        <include name="**/*.properties"/>
        <include name="**/*.pem"/>
        <include name="**/testUserDb.txt"/>
      </fileset>
    </copy>
  </target>

  <target name="test-java" depends="test-java-nonet,test-java-needsnet"/>

  <target name="test-java-nonet" depends="init-tests,compile-java-tests">
      <junit printsummary="yes"  includeAntRuntime="true" haltonfailure="yes">
        <classpath refid="classpath.test" />
        <formatter type="plain" />
        <batchtest todir="${dir.testreport}">
          <fileset dir="${dir.test.classes}">
            <include name="**/*Test.class" />
            <exclude name="**/*NetTest.class" />
          </fileset>
        </batchtest>
        <sysproperty key="test.dbfile" 
                     value="${dir.test.src.java}/testUserDb.txt"/>
        <sysproperty key="test.tmpdir" value="${dir.tmp}"/>
      </junit>
  </target>

  <target name="test-java-needsnet" depends="init-tests,compile-java-tests">
      <junit printsummary="yes"  includeAntRuntime="true" haltonfailure="yes">
        <classpath refid="classpath.test" />
        <formatter type="plain" />
        <batchtest todir="${dir.testreport}">
          <fileset dir="${dir.test.classes}">
            <include name="**/*NetTest.class" />
          </fileset>
        </batchtest>
        <sysproperty key="test.dbfile" 
                     value="${dir.test.src.java}/testUserDb.txt"/>
        <sysproperty key="test.tmpdir" value="${dir.tmp}"/>
      </junit>
  </target>

  <target name="test-python" depends="test-python-nonet,test-python-needsnet" />

  <target name="test-python-nonet" depends="init-tests,build-python">
    <exec executable="${python.exe}">
      <arg file="${dir.ptest}/testNoNet.py"/>
      <arg file="${dir.testreport}"/>
      <env key="PYTHONPATH" path="${pythonpath}" />
    </exec>
  </target>

  <target name="test-python-needsnet" depends="init-tests,build-python">
    <exec executable="${python.exe}">
      <arg file="${dir.ptest}/testNeedsNet.py"/>
      <arg file="${dir.testreport}"/>
      <env key="PYTHONPATH" path="${pythonpath}" />
    </exec>
  </target>

  <target name="clean" depends="lo.cleanOutputDirs">

  </target>

  <target name="distclean" depends="lo.distCleanOutputDirs">
    <delete file="${target.jar.path}"/>
    <delete dir="${dir.plib}"/>
  </target>

  <target name="try">
    <echo message="bin: ${dir.bin}"/>
  </target>

  <target name="show-test-cp">
    <echo message="classpath: ${toString:classpath.test}"/>
  </target>

  <target name="show-build-cp">
    <echo message="classpath: ${toString:classpath.build}"/>
  </target>

  <target name="test-java-now" depends="init-tests,compile-java-tests">
      <junit printsummary="yes"  includeAntRuntime="true" haltonfailure="yes">
        <classpath refid="classpath.test" />
        <formatter type="plain" />
        <batchtest todir="${dir.testreport}">
          <fileset dir="${dir.test.classes}">
            <include name="**/*FileUserDbTest.class" />
            <exclude name="**/*NetTest.class" />
          </fileset>
        </batchtest>
        <sysproperty key="test.dbfile" 
                     value="${dir.test.src.java}/testUserDb.txt"/>
        <sysproperty key="test.tmpdir" value="${dir.tmp}"/>
      </junit>
  </target>

</project>

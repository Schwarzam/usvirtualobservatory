<project name="DataScope" default="jar" basedir=".">
<description> Virtual Observatory DataScope </description>

<property name="proj"     value="datascope" />
<property file="../../net_ivoa/trunk/heasarc.properties"/>

<filter token="URL_PATH" value="${URL_PATH}"/>
<filter token="CSS_PATH" value="${CSS_PATH}"/>
<filter token="JS_PATH"  value="${JS_PATH}"/>
<filter token="ABS_PATH" value="${ABS_PATH}"/>
<filter token="RUNTIME"  value="${RUNTIME}"/>
<filter token="IMG_PATH" value="${IMG_PATH}"/>
<filter token="XSL_PATH" value="${XSL_PATH}"/>
<filter token="XSL_RUN"  value="${XSL_RUN}"/>
<filter token="VIM"      value="${VIM}"/>
<filter token="Inventory" value="${Inventory}"/>
<filter token="DSData"   value="${DSData}"/>
<filter token="DSCache"  value="${DSCache}"/>

<target name="check_dependencies"  >
   <available file="${ivoalib}" property="${ivoalib}.present"/>
   <fail message="Cannot find ${ivoalib} which is required to build this project"
      unless="${ivoalib}.present"/>
   <echo message="Found ${ivoalib}" />
   <available file="${nvolib}" property="${nvolib}.present"/>
   <fail message="Cannot find ${nvolib} which is required to build this project"
      unless="${nvolib}.present"/>
   <echo message="Found ${nvolib}" />
   <available file="${vovlib}" property="${vovlib}.present"/>
   <fail message="Cannot find ${vovlib} which is required to build this project"
      unless="${vovlib}.present"/>
   <echo message="Found ${vovlib}" />
   <available file="${skylib}" property="${skylib}.present"/>
   <fail message="Cannot find ${skylib} which is required to build this project"
      unless="${skylib}.present"/>
   <echo message="Found ${skylib}" />
</target>

<target name="merge_java"  depends="check_dependencies" >
   <mkdir dir="${srcdir}" />
   <echo message="Merging Java files." />
   <copy todir="${srcdir}" filtering='true'>
      <fileset includes="**/*.java" dir="${nvolib}/trunk/src/java/" />
      <fileset includes="**/*.java" dir="${ivoalib}/trunk/src/java/" />
      <fileset includes="**/*.java" dir="${java}" />
   </copy>
</target>

<target name="skyview" >
   <ant dir="${skylib}/trunk/" target="jar" inheritAll="false" />
   <mkdir dir="${jars}" />
   <copy file="${skylib}/trunk/tmp/jars/skyview.jar" todir="${jars}/" />
</target>

<target name="compile" depends="merge_java,skyview" >
   <mkdir dir="${classes}" />
   <javac destdir="${classes}" srcdir="${srcdir}" >
<!--
includes="net/ivoa/util/**,net/ivoa/registry/**,net/ivoa/datascope/**,net/nvo/**"
<compilerarg value="-Xlint:unchecked" />
-->
      <classpath>
         <pathelement location="${classes}" />
         <pathelement location="${jars}/skyview.jar" />
         <pathelement location="${fjars}/tar.jar" />
         <pathelement location="${fjars}/axis-ant.jar" />
         <pathelement location="${fjars}/axis-schema.jar" />
         <pathelement location="${fjars}/axis.jar" />
         <pathelement location="${fjars}/commons-discovery-0.2.jar" />
         <pathelement location="${fjars}/commons-logging-1.0.4.jar" />
         <pathelement location="${fjars}/jaxrpc.jar" />
         <pathelement location="${fjars}/log4j-1.2.8.jar" />
         <pathelement location="${fjars}/saaj.jar" />
         <pathelement location="${fjars}/wsdl4j-1.5.1.jar" />
         <pathelement location="${fjars}/activation.jar" />
         <pathelement location="${fjars}/mail.jar" />
         <pathelement location="${fjars}/commons-lang-2.1.jar" />
      </classpath>
   </javac>
</target>

<target name="clean">
   <delete failonerror="false">
      <fileset dir="${classes}" includes="net/nvo/**,net/ivoa/util/**,net/ivoa/registry/**,net/ivoa/datascope/**" />
      <fileset dir="${javadocs}/${proj}" />
   </delete>
   <delete file="${jar}" failonerror="false"/>
   <exec executable="find">
      <arg value="${srcdir}/net/ivoa/" />
      <arg value="-name" />
      <arg value="*.java~" />
      <arg value="-exec" />
      <arg value="rm"    />
      <arg value="{}"    />
      <arg value=";"     />
   </exec>
   <exec executable="find">
      <arg value="${cgi}" />
      <arg value="-name" />
      <arg value="*~"    />
      <arg value="-exec" />
      <arg value="rm"    />
      <arg value="{}"    />
      <arg value=";"     />
   </exec>
   <exec executable="find">
      <arg value="${css}" />
      <arg value="-name" />
      <arg value="*~"    />
      <arg value="-exec" />
      <arg value="rm"    />
      <arg value="{}"    />
      <arg value=";"     />
   </exec>
   <exec executable="find">
      <arg value="${docs}" />
      <arg value="-name" />
      <arg value="*~"    />
      <arg value="-exec" />
      <arg value="rm"    />
      <arg value="{}"    />
      <arg value=";"     />
   </exec>
   <exec executable="find">
      <arg value="${js}" />
      <arg value="-name" />
      <arg value="*~"    />
      <arg value="-exec" />
      <arg value="rm"    />
      <arg value="{}"    />
      <arg value=";"     />
   </exec>
</target>

<target name='jar' depends="compile" >
   <mkdir dir="${jars}" />
   <jar destfile="${jar}" update="false" basedir="${classes}" />
<!--
includes="net/ivoa/util/**,net/ivoa/registry/**,net/ivoa/datascope/**,net/nvo/**"
-->
<!-- make the entire tmp directory group writable -->
   <chmod dir="${tmp}" type="both" includes="**" perm="g+w" />
</target>

<target name="release" depends="clean,jar">
</target>

<target name="install" depends="release">

   <echo message="Clearing out old directories" />
   <echo message="cgidest = ${cgidest}" />

   <delete failonerror="false" dir="${cgidest}" />
   <delete failonerror="false" dir="${jsdest}"  />
   <delete failonerror="false" dir="${cssdest}" />
   <delete failonerror="false" dir="${docsdest}"/>

   <echo message="Copying CGI scripts" />
   <copy todir="${cgidest}" includeEmptyDirs='false' filtering='true'>
      <fileset dir="${cgi}" >
         <exclude name="**/versions/*" />
      </fileset>
      <fileset includes="**/*.pl" dir="${vovlib}/trunk/src/cgi/" />
   </copy>
   <chmod dir="${cgidest}" includes="*" perm="ugo+x" />
   <concat destfile="${cgidest}/vo.settings" append="true">
      <filelist dir="${nvolib}/trunk/src/cgi/" files="net_nvo.settings"/>
   </concat>

   <echo message="Copying HTML documentation" />
   <copy todir="${docsdest}" includeEmptyDirs='false'>
      <fileset dir="${docs}">
         <exclude name="**/versions/*" />
      </fileset>
      <fileset dir="${nvolib}/trunk/src/html/">
         <exclude name="**/versions/*" />
      </fileset>
   </copy>

   <echo message="Merging all JavaScript in ${jsdest}" />
   <copy todir="${imgdest}" overwrite='true' >
      <fileset dir="${vovlib}/trunk/src/images/" >
         <exclude name="**/versions/*" />
      </fileset>
   </copy>

   <echo message="Copying JavaScript" />
   <echo message="Merging all JavaScript in ${jsdest}" />
   <copy todir="${jsdest}" overwrite='true' >
      <fileset includes="**/*.js" dir="${vovlib}/foreign/javascript/" />
   </copy>
   <copy todir="${jsdest}" overwrite='true' >
      <fileset includes="**/*.js" dir="${vovlib}/mods/javascript/" />
   </copy>
   <copy todir="${jsdest}" overwrite='true'  filtering='true'>
      <fileset includes="**/*.js" dir="${vovlib}/trunk/src/javascript/" />
   </copy>

   <copy todir="${jsdest}" includeEmptyDirs='false' filtering='true'>
      <fileset dir="${js}" includes="**/*.js"/>
   </copy>

   <echo message="Copying CSS" />
   <copy todir="${cssdest}" includeEmptyDirs='false' filtering='true'>
      <fileset includes="**/*.css" dir="${nvolib}/trunk/src/css/" />
      <fileset includes="**/*.css" dir="${vovlib}/trunk/src/css/" />
      <fileset dir="${css}" includes="**/*.css" />
   </copy>

   <echo message="Merging all XSL in ${xsldest}" />
   <copy todir="${xsldest}" overwrite='true' >
      <fileset includes="**/*.xsl" dir="${vovlib}/trunk/src/xsl/" />
   </copy>
   <copy todir="${xsldest}" overwrite='true' >
      <fileset includes="**/*.xsl" dir="${xsl}" />
   </copy>

   <echo message="Copying Jar files." />
   <copy todir="${jardest}" file="${jars}/skyview.jar" />
   <copy todir="${jardest}" file="${fjars}/tar.jar" />
   <copy todir="${jardest}" file="${fjars}/axis-ant.jar" />
   <copy todir="${jardest}" file="${fjars}/axis-schema.jar" />
   <copy todir="${jardest}" file="${fjars}/axis.jar" />
   <copy todir="${jardest}" file="${fjars}/commons-discovery-0.2.jar" />
   <copy todir="${jardest}" file="${fjars}/commons-logging-1.0.4.jar" />
   <copy todir="${jardest}" file="${fjars}/jaxrpc.jar" />
   <copy todir="${jardest}" file="${fjars}/log4j-1.2.8.jar" />
   <copy todir="${jardest}" file="${fjars}/saaj.jar" />
   <copy todir="${jardest}" file="${fjars}/wsdl4j-1.5.1.jar" />
   <copy todir="${jardest}" file="${fjars}/activation.jar" />
   <copy todir="${jardest}" file="${fjars}/mail.jar" />
   <copy todir="${jardest}" file="${fjars}/commons-lang-2.1.jar" />

   <echo message="Installing new JAR" />
   <copy file="${jar}" todir="${jardest}" />
   <chmod dir="${cgidest}" includes="*" perm="ugo+x" />
   <chmod dir="${docsdest}" includes="**" type="both" perm="g+w" />
   <chmod dir="${cgidest}" includes="**" type="both" perm="g+w" />
</target>

<target name="javadoc">
   <delete failonerror="false" >
      <fileset dir="${javadocs}/${proj}" />
   </delete>
   <javadoc sourcepath="${srcdir}" destdir="${javadocs}/${proj}" 
      packagenames="net.ivoa.util,net.ivoa.datascope,net.ivoa.registry,net.nvo" >
      <classpath>
         <pathelement location="${jars}/skyview.jar" />
         <pathelement location="${fjars}/tar.jar" />
         <pathelement location="${fjars}/axis-ant.jar" />
         <pathelement location="${fjars}/axis-schema.jar" />
         <pathelement location="${fjars}/axis.jar" />
         <pathelement location="${fjars}/commons-discovery-0.2.jar" />
         <pathelement location="${fjars}/commons-logging-1.0.4.jar" />
         <pathelement location="${fjars}/jaxrpc.jar" />
         <pathelement location="${fjars}/log4j-1.2.8.jar" />
         <pathelement location="${fjars}/saaj.jar" />
         <pathelement location="${fjars}/wsdl4j-1.5.1.jar" />
         <pathelement location="${fjars}/activation.jar" />
         <pathelement location="${fjars}/mail.jar" />
         <pathelement location="${fjars}/commons-lang-2.1.jar" />
      </classpath>
   </javadoc>
</target>
</project>

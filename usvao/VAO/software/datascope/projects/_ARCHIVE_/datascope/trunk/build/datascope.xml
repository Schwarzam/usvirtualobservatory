<project name="DataScope" default="jar" basedir="..">
    <description> Virtual Observatory DataScope </description>
    
    <property name="proj"    value="datascope"           />
    <property name="srcproj" value="${proj}"             />
    <property name="dstproj" value="${proj}"             />
    <property name="classes" value="./class"             />
    <property name="data"    value="./data"             />
    <property name="sources" value="./source"            />
    <property name="javadocs" value="./javadoc"          />
    <property name="css"     value="./css/${srcproj}"       />
    <property name="cgi"     value="./cgi/${srcproj}"       />
    <property name="js"      value="./js/${srcproj}"        />
    <property name="docs"    value="./docs/${srcproj}"      />
    <property name="fjars"   value="./fjar"              />
    <property name="ljars"   value="./ljar"              />
    <property name="jar"     value="${ljars}/${dstproj}.jar"/>
    
    <target name="installNames" depends="devNames,relNames,commonNames" />
    <target name="devNames" unless="prod" >
        <property name="host"     value="heasarcdev.gsfc.nasa.gov" />
	<property name="copyExt"  value="" />
    </target>
    <target name="relNames" if="prod" >
        <property name="host"     value="heasarc.gsfc.nasa.gov"    />
	<property name="copyExt"  value=".prod" />
    </target>
    <target name="commonNames">
        <property name="base"     value="/www${copyExt}/htdocs" />
        <property name="dest"     value="/vo/${dstproj}/"        />    
        <property name="docsdest" value="${base}/${dest}/"       />
        <property name="jsdest"   value="${docsdest}/js/"           />
        <property name="cssdest"  value="${docsdest}/css/"          />
        <property name="cgidest"  value="${base}/cgi-bin/${dest}/"  />
        <property name="jardest"  value="${base}/vo/java/"          />
        <property name="jarname"  value="${dstproj}.jar"              />
	<property name="cgibase"  value="/cgi-bin${dest}"          />
	<property name="urlbase"  value="${dest}"                  />
    </target>
    
    <target name="compile"  >
        <javac destdir="${classes}"
	       srcdir="${sources}"
	       includes="net/ivoa/util/**,net/ivoa/registry/**,net/ivoa/datascope/**"
	       debug="on"
	>
           <classpath>
	      <pathelement location="${classes}" />
              <pathelement location="${ljars}/skyview.jar" />
	      <pathelement location="${fjars}/tar.jar" />
	      <pathelement location="${fjars}/axis-ant.jar" />
	      <pathelement location="${fjars}/axis-schema.jar" />
	      <pathelement location="${fjars}/axis.jar" />
	      <pathelement location="${fjars}/commons-discovery-0.2.jar" />
	      <pathelement location="${fjars}/commons-logging-1.0.4.jar" />
	      <pathelement location="${fjars}/jaxrpc.jar" />
	      <pathelement location="${fjars}/log4j-1.2.8.jar" />
	      <pathelement location="${fjars}/saaj.jar" />
	      <pathelement location="${fjars}/wsdl4j-1.5.1.jar" />
	      <pathelement location="${fjars}/activation.jar" />
	      <pathelement location="${fjars}/mail.jar" />
	   </classpath>
	</javac>
    </target>
    
    <target name="clean">
        <delete failonerror="false">
	    <fileset dir="${classes}" includes="net/ivoa/util/**,net/ivoa/registry/**,net/ivoa/datascope/**" />
	    <fileset dir="${javadocs}/${proj}" />
	</delete>
	<delete file="${jar}" failonerror="false"/>
	<exec executable="find">
	    <arg value="${sources}/net/ivoa/" />
	    <arg value="-name"      />
	    <arg value="*.java~"    />
	    <arg value="-exec"      />
	    <arg value="rm"         />
	    <arg value="{}"         />
	    <arg value=";"          />
	</exec>
	<exec executable="find">
	    <arg value="${cgi}" />
	    <arg value="-name"      />
	    <arg value="*~"    />
	    <arg value="-exec"      />
	    <arg value="rm"         />
	    <arg value="{}"         />
	    <arg value=";"          />
	</exec>
	<exec executable="find">
	    <arg value="${css}" />
	    <arg value="-name"      />
	    <arg value="*~"    />
	    <arg value="-exec"      />
	    <arg value="rm"         />
	    <arg value="{}"         />
	    <arg value=";"          />
	</exec>
	<exec executable="find">
	    <arg value="${docs}" />
	    <arg value="-name"      />
	    <arg value="*~"    />
	    <arg value="-exec"      />
	    <arg value="rm"         />
	    <arg value="{}"         />
	    <arg value=";"          />
	</exec>
	<exec executable="find">
	    <arg value="${js}" />
	    <arg value="-name"      />
	    <arg value="*~"    />
	    <arg value="-exec"      />
	    <arg value="rm"         />
	    <arg value="{}"         />
	    <arg value=";"          />
	</exec>
    </target>
    	
    <target name='jar' depends="compile" >
    
       <jar destfile="${jar}" update="false" basedir="${classes}" 
	    includes="net/ivoa/util/**,net/ivoa/registry/**,net/ivoa/datascope/**,net/nvo/**"
        />
       <jar destfile="${jar}" update="true" basedir="${data}/${proj}" 
	    includes="**"
        />
    </target>
    
    <target name="release" depends="clean,jar">
    </target>
    
    <target name="install" depends="release,installNames">
        <echo message="Installing:"                      />
	<echo message="  Host: ${host}"                    />
	<echo message="  Documents to ${docsdest}"       />
	<echo message="  JavaScript to ${jsdest}"        />
	<echo message="  CGI Scripts to ${cgidest}"      />
	<echo message="  CSS files to ${cssdest}"        />
	<echo message="  JAR to ${jardest}${jarname}"   />
	<echo message="  CGI files seen as: ${cgibase}"  />
	<echo message="  DOCS files seen as: ${urlbase}" />
    
        <echo message="Clearing out old directories" />
        <delete failonerror="false" dir="${cgidest}" />
	<delete failonerror="false" dir="${jsdest}"  />
	<delete failonerror="false" dir="${cssdest}" />
	<delete failonerror="false" dir="${docsdest}"/>
	
        <echo message="Copying CGI scripts" />
	<copy todir="${cgidest}" >
	   <fileset dir="${cgi}"  />
	</copy>
        <chmod dir="${cgidest}" includes="*" perm="ugo+x" />
	<echo message="Copying HTML documentation and XSL" />
	<copy todir="${docsdest}">
	    <fileset dir="${docs}" />
	</copy>	
	<copy todir="${docsdest}/xsl" >
	    <fileset dir="docs/query/xsl" />
	</copy>
        <chmod dir="${docsdest}" includes="*.csh" perm="ugo+x" />
	
	<echo message="Copying JavaScript" />
	<copy todir="${jsdest}">
	    <fileset dir="${js}"     />
	    <fileset dir="js/query/" />
	</copy>
	
	<echo message="Copying CSS" />
	<copy todir="${cssdest}">
	    <fileset dir="${css}"    />
	    <fileset dir="css/query" />
	</copy>
	
	<echo message="Copying external Jar files." />
        <copy todir="${jardest}" file="${ljars}/skyview.jar" />
	<copy todir="${jardest}" file="${fjars}/tar.jar" />
	<copy todir="${jardest}" file="${fjars}/axis-ant.jar" />
	<copy todir="${jardest}" file="${fjars}/axis-schema.jar" />
	<copy todir="${jardest}" file="${fjars}/axis.jar" />
	<copy todir="${jardest}" file="${fjars}/commons-discovery-0.2.jar" />
	<copy todir="${jardest}" file="${fjars}/commons-logging-1.0.4.jar" />
	<copy todir="${jardest}" file="${fjars}/jaxrpc.jar" />
	<copy todir="${jardest}" file="${fjars}/log4j-1.2.8.jar" />
	<copy todir="${jardest}" file="${fjars}/saaj.jar" />
	<copy todir="${jardest}" file="${fjars}/wsdl4j-1.5.1.jar" />
	<copy todir="${jardest}" file="${fjars}/activation.jar" />
	<copy todir="${jardest}" file="${fjars}/mail.jar" />
	
	<echo message="Installing new JAR" />
	<copy file="${jar}" tofile="${jardest}/${jarname}" />
	
	<echo message="Updating classpath in Common.pm" />
        <replace file="${cgidest}/Common.pm" token="datascope.jar" value="${jarname}" /> 
	
	<echo message="Updating settings" />
	<replace file="${cgidest}/vo.settings" token="$HOST"    value="${host}" />
	<replace file="${cgidest}/vo.settings" token="$CGIBASE" value="${cgibase}" />
	<replace file="${cgidest}/vo.settings" token="$URLBASE" value="${urlbase}" />
	
	<echo message="Pointing JS to correct host" />
	<replace file="${jsdest}/datascope.js"  token="heasarc.gsfc.nasa.gov" value="${host}" />
	
	<echo message="Install complete" />

	
    </target>
    
    <target name="javadoc">
        <delete failonerror="false" >
	    <fileset dir="${javadocs}/${proj}" />
	</delete>
        <javadoc sourcepath="${sources}" destdir="${javadocs}/${proj}" 
	   packagenames="net.ivoa.util,net.ivoa.datascope,net.ivoa.registry" >
           <classpath>
              <pathelement location="${ljars}/skyview.jar" />
	      <pathelement location="${fjars}/tar.jar" />
	      <pathelement location="${fjars}/axis-ant.jar" />
	      <pathelement location="${fjars}/axis-schema.jar" />
	      <pathelement location="${fjars}/axis.jar" />
	      <pathelement location="${fjars}/commons-discovery-0.2.jar" />
	      <pathelement location="${fjars}/commons-logging-1.0.4.jar" />
	      <pathelement location="${fjars}/jaxrpc.jar" />
	      <pathelement location="${fjars}/log4j-1.2.8.jar" />
	      <pathelement location="${fjars}/saaj.jar" />
	      <pathelement location="${fjars}/wsdl4j-1.5.1.jar" />
	      <pathelement location="${fjars}/activation.jar" />
	      <pathelement location="${fjars}/mail.jar" />
	   </classpath>
	</javadoc>
    </target>
    
    <target name="tonvo">
    
        <echo message="Copying CGI scripts" />
	<copy todir="../nvo/projects/${proj}/trunk/cgi/" >
	   <fileset dir="${cgi}"  />
	</copy>
        <chmod dir="../nvo/projects/${proj}/trunk/cgi" includes="*" perm="ugo+x" />
	
	<echo message="Copying HTML documentation and XSL" />
	<copy todir="../nvo/projects/${proj}/trunk/htdocs" >
	    <fileset dir="${docs}" />
	</copy>
        <chmod dir="../nvo/projects/${proj}/trunk/htdocs" includes="*.csh" perm="ugo+x" />
	
	<echo message="Copying JavaScript" />
	
	<copy todir="../nvo/projects/${proj}/trunk/htdocs/js">
	    <fileset dir="${js}"     />
	    <fileset dir="js/query/" />
	</copy>
	
	<copy todir="../nvo/projects/${proj}/trunk/source">
	    <fileset dir="${sources}" includes="net/ivoa/datascope/** net/nvo/** net/ivoa/util/**" />
	</copy>
	
	<echo message="Copying CSS" />
	<copy todir="../nvo/projects/${proj}/trunk/htdocs/css">
	    <fileset dir="css/query" />
	    <fileset dir="${css}"    />
	</copy>
	
	<copy todir="../nvo/projects/${proj}/trunk/build" >
	    <fileset dir="./build" includes="datascope.xml" />
	</copy>
	
	<copy todir="../nvo/projects/${proj}/trunk/data" >
	    <fileset dir="${data}/${proj}" />
	</copy>
	
	<echo message="Distribution complete" />
    </target>
</project>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>
				<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>EURO-VO :: CS Validater :: Validate</title>
		<link rel="stylesheet" type="text/css" href="http://registry.euro-vo.org/eurovo.css" />
		<link rel="stylesheet" type="text/css" href="http://registry.euro-vo.org/eurovo-tc.css" />
		<script type="text/javascript" src="MochiKit.js"></script>
  <style type="text/css">
<!--
.tiny {FONT-SIZE: 7pt;}
.story p {padding: 0px 0px 0px 0px;}
-->
  </style>
		<link href="usvo_template.css" rel="stylesheet" type="text/css"/>

	</head>
	<body>
		
<div id="pagecell1" style="width:900px;">
	<div id="banner">
		<img alt="" src="http://registry.euro-vo.org/tl_curve_black.gif" height="6" width="6" id="tl"> <img alt="" src="http://registry.euro-vo.org/tr_curve_black.gif" height="6" width="6" id="tr">
		<a href="http://www.euro-vo.org/pub/index.html"><img src="http://registry.euro-vo.org/null.gif" height="91" width="900" border="0"></a>
	</div>
	<div id="banner-print"><img alt="Euro-VO" src="http://registry.euro-vo.org/euro_vo_bw_wb.gif"><hr></div>
	<div id="sub-banner">
		<b>The Euro-VO projects:</b> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
		<a href="http://eurovotech.org"><span class="sub-banner-tc"><b>VOTECH</b></span></a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
		<a href="http://cds.u-strasbg.fr/twikiDCA/bin/view/EuroVODCA/WebHome"><span class="sub-banner-dca"><b>EuroVO-DCA</b></span></a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
		<a href="http://cds.u-strasbg.fr/twikiAIDA/bin/view/EuroVOAIDA/WebHome"><span class="sub-banner-aida"><b>EuroVO-AIDA</b></span></a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

	</div>

<div id="content" style="margin-left:0px; border:none;">
    <div class="story">

<!-- =======================================================================
  -  Page Content
  -  ======================================================================= -->

<a href="csvalidate.html" style="TEXT-DECORATION: none;">
<h1>Cone Search Validation</h1>
</a> <p>

<p>
To test a <a href="http://www.ivoa.net/Documents/latest/ConeSearch.html">Cone Search Service</a>, enter its base URL below along with a
position and radius that you expect to return at least two records,
then press "validate". 
</p>

<p>
Unless the "Results Format" is set to "VOTable", this service will
actually send three queries to the service.  In addition to the query
specified below, a <a href="conesearch.html#3d"><em>metadata
query</em> (where SR=0)</a> and an erroneous query are also sent.
When the "VOTable" format is selected, only the VOTable response to
the query below is returned directly to the browser.
</p> 

<form action="ConeSearchValidater"
      method="GET" name="validateForm" onsubmit="return validate()">
<p style="margin-top: 12pt;">
BASEURL: <span id="checkBASEURL"></span>
<input name="endpoint" type="text" size="80" /> <br />
</p>

<table border="0" cellspacing="0" cellpadding="0">
  <tr>
    <td align="left"> RA: </td>
    <td width="5"></td>
    <td align="left">  <input name="RA" type="text" size="15" value="180.0" />
       <span id="checkRA"></span> </td>
  </tr>
  <tr>
    <td align="left"> DEC: </td>
    <td width="5"></td>
    <td align="left"><input name="DEC" type="text" size="15" value="60.0" /> 
       <span id="checkDEC"></span></td>
  </tr>
  <tr>
    <td align="left"> Search Radius (SR): </td>
    <td width="5"></td>
    <td align="left"><input name="SR" type="text" size="15" value="1.0" /> 
       <span id="checkSR"></span><br />
    </td>
  </tr>
</table>

<p>
Results Format:  <select name="format">
    <option selected value="html">HTML</option>
    <option value="xml">XML</option>
    <option value="votable">VOTable (just return service response)</option>
</select> <br />
Include in the output:  <span id="checkShow"></span><br />
<input type="checkbox" name="show" value="fail" checked="true" />
   Failures (Compliance Errors) &nbsp;&nbsp;
<input type="checkbox" name="show" value="warn" checked="true" />
   Warnings &nbsp;&nbsp;
<input type="checkbox" name="show" value="rec" checked="true" />
   Recommendations &nbsp;&nbsp;
<input type="checkbox" name="show" value="pass" />
   Passed Tests &nbsp;&nbsp; <br />
</p>

<input type="submit" value="validate"/>
</form>

<div id="status">
<h3 id="message" style="padding-bottom: 0px; margin-bottom: 0px; display: none;">Validation Request Submitted...</h3>

<div id="progress" itemnode="li" style="display: none">
Progress:
<ul style="padding-top: 0px; margin-top: 0px;">
   <li class="progressItem">holder</li>
</ul>
</div>
</div>

<script type="text/javascript">
<!--

var form = document.validateForm;
var validaterServiceURL = form.action + "?";
var statusCount = 300;
var statusErrorCount = 5;
var statusDiv = document.getElementById("status");
var statusMsgDiv = null;
var statusProgDiv = null;
if (statusDiv != null) {
    statusMsgDiv  = document.getElementById("message"); 
    statusProgDiv = document.getElementById("progress");
}

function setProgressMessages(msgs, count) {
    logDebug("setProgressMessages: " + msgs);

    if (statusDiv == null) {
        log("Missing status element in html form");
        return;
    }

    if (statusProgDiv != null) {
        var itemnode = statusProgDiv.getAttribute("itemnode");
        if (itemnode == null) {
            logError("itemnode attribute didn't take");
            itemnode = "span";
        }
        var nodes = statusProgDiv.getElementsByTagName(itemnode);
        var m = 0;
        var itemparent = null;
        var firstitem = null; 
        if (nodes.length == 0) {
            logError("no " + itemnode + " elements found.");
        }
        for (var i=0; i < nodes.length; i++) {
            if (nodes[i].className == "progressItem") {
                if (firstitem == null) firstitem = nodes[i];
                if (m < msgs.length) {
                    nodes[i].innerHTML = msgs[m++];
                    nodes[i].style.display = "block";
                }
                else {
                    nodes[i].style.display = "none";
                }
            }
        }

        var item = null;
        while (m < msgs.length && firstitem != null) {
            item = firstitem.cloneNode(true);
            item.innerHTML = msgs[m++];
            item.style.display = "block";
            firstitem.parentNode.appendChild(item);
        }

        statusProgDiv.style.display = "block";
    }
    else {
        logError("missing progress section");
    }

}

function setStatusMessage(msg) {
    logDebug("setting status message: " + msg);
    if (statusMsgDiv != null) {
        statusMsgDiv.innerHTML = msg;
        statusMsgDiv.style.display = "block";
    }
    else {
        logError("missing message section");
    }
}

function updateStatus(resp) {
    logDebug("updateStatus: status (" + statusCount + "): " + resp.responseText);
    var status = evalJSONRequest(resp);
    logDebug("updateStatus: status (" + statusCount + "): " + status.status);
    try{

        var msg = "";
        if (status.ok != null && ! status) {
            msg += "Problem with the " + status.lastQueryName + ": " + 
                status.message;
        }
        else if (status.message != null && status.message != "") {
            msg += status.message;
        }
        else if (status.status == "running") {
            msg = "Validation in progress...";
        }
        else if (status.status == "done") {
            msg = "Validation complete.";
        }
        else {
            msg = status.status + "...";
        }
        if (msg != "") setStatusMessage(msg);

        if (status.progress != null && status.progress.length > 0) {
            setProgressMessages(status.progress);
        }

        if (statusCount > 0 && status.status != 'done') {
            statusCount--;
            try {
                setTimeout(getStatus, 1000);
                //         callLater(1, getStatus);
            }
            catch (e) {
                logError("handleStatusError: " + e.name+ ": " + e.message);
            }
        }
    }
    catch (e) {
        var lno = "unknown location";
        try {
            lno = e.fileName + ": " + e.lineNumber;
        } catch(err) { }
        logError("updateStatus: error: " + e.name + " (" + lno + 
                 "): " + e.message);
    }
    return true;
}

function handleStatusError(resp) {
    logError("Problem getting status: " + resp.message);
    setStatusMessage("Problem getting status: " + resp.message);
    
    if (statusErrorCount > 0) {
        statusErrorCount--;
        try {
            setTimeout(getStatus, 1000);
//         callLater(1, getStatus);
        }
        catch (e) {
            logError("handleStatusError: " + e.name+ ": " + e.message);
        }
    }
    return true;
}

function handleValidateError(error) {
    logError("Problem getting results: " + error.message);
    setStatusMessage("Problem getting results: " + error.message);
    return true;
}

function getStatus() {
    log("getting status from " + validaterServiceURL);
    try {
        var url = validaterServiceURL + "op=GetStatus&errorFormat=json";
        var ajax = doXHR(url, {method: 'GET'});
        ajax.addCallbacks(updateStatus, handleStatusError);
    }
    catch (e) {
        logError("getStatus: " + e);
    }

    return true;
}

function logresp(resp) {
    logDebug("status: " + resp.responseText);
}

function validate() {
//    logger.debuggingBookmarklet();

    clearOldResults();
    validaterServiceURL = form.action + "?";
    if (checkInputs()) {
        var format = form.elements.format;
        if (format.options[format.selectedIndex].value != "votable") {
            if (statusMsgDiv != null) {
                statusMsgDiv.style.display = "block";
            }
            else {
                logError("no statusMsgDiv available");
            }
            var url = getGetURL() + "op=StartSession";
            log("Starting session with: " + url);
            var ajax = doXHR(url, {method: 'GET'});
            ajax.addCallbacks(requestValidate, handleValidateError);
        }
        else {
            form.submit();
        }
    }
    return false;  
}

function requestValidate(resp) {
    var session = evalJSONRequest(resp);
    logDebug("requestValidate: using session base URL: " + 
             session.sessionURL);

    if (! session.sessionURL.match("^http://"))
        throw new Error("bad sessionURL: " + session.sessionURL);

    validaterServiceURL = session.sessionURL;
//     var url = session.sessionURL + "op=Validate";
//     var ajax = doXHR(url, {method: 'GET', mimeType: 'text/xml'});
    var url = session.sessionURL + "cache=true&op=Validate";
    logDebug("retrieving results from: " + url);
    var ajax = doXHR(url, {method: 'GET'});
    ajax.addCallbacks(loadResults, handleValidateError);
    getStatus();
}

function clearOldResults() {
//     clrdDiv = DIV({id: "results"});
//     swapDOM(document.getElementById("results"), clrdDiv);
}

function trim(text) {
    if (text == null || text.length == 0) return text;
    return text.replace(/^\s+|\s+$/g, '');
}

function checkInputs() {
    var ok = true;
    if (trim(form.endpoint.value).length == 0) {
        ok = false;
        addInputTip("checkBASEURL", 
                    "Please provide the legal URL for your service to check");
    }

    var val = trim(form.RA.value);
    if (val.length == 0) {
        val = null;
    }
    else if (! /^[+\-]?((\d+\.?\d*)|(\.\d+))([eE][+\-]?\d{1,3})*$/.exec(val)) {
        val = null;
    }
    else {
        val = parseFloat(val);
        if (isNaN(val)) val = null;
        if (val < 0.0 || val > 360.0) val = null;
    }
    if (val == null) {
        ok = false;
        addInputTip("checkRA", 
                    "Please provide a right ascension in " +
                    "decimal degrees (range: 0, 360).");
    }
 
    val = trim(form.DEC.value);
    if (val.length == 0) {
        val = null;
    }
    else if (! /^[+\-]?((\d+\.?\d*)|(\.\d+))([eE][+\-]?\d{1,3})*$/.exec(val)) {
        val = null;
    }
    else {
        val = parseFloat(val);
        if (isNaN(val)) val = null;
        if (val < -90.0 || val > 90.0) val = null;
    }
    if (val == null) {
        ok = false;
        addInputTip("checkDEC", 
                    "Please provide a declination in " +
                    "decimal degrees (range: -90, 90).");
    }
 
    val = trim(form.SR.value);
    if (val.length == 0) {
        val = null;
    }
    else if (! /^[+\-]?((\d+\.?\d*)|(\.\d+))([eE][+\-]?\d{1,3})*$/.exec(val)) {
        val = null;
    }
    else {
        val = parseFloat(val);
        if (isNaN(val)) val = null;
        if (val < 0.0 || val > 180.0) val = null;
    }
    if (val == null) {
        ok = false;
        addInputTip("checkSR", 
                    "Please provide a search radius in " + 
                    "decimal degrees (range: 0, 180).");
    }

    var show = form.show;
    val = false;
    for(var i=0; i < show.length; i++) {
        if (show[i].checked) {
            val = true;
            break;
        }
    }
    if (! val) {
        ok = false;
        addInputTip("checkShow", 
                 "Please check at least one test class to include in output");
    }
 
    return ok;
}

function testInputs() {
    clearOldResults()
    checkInputs();
//     alert(getGetURL());
    return false;
}

function addInputTip(id, msg) {
    div = document.getElementById(id);

    if (div != null) {
        while (div.hasChildNodes()) {
            div.removeChild(div.firstChild);
        }
        div.appendChild(createDOM("FONT", {color: "red", size: "-1"}, msg));
    }
}

function getGetURL() {
    var out = validaterServiceURL;
    var inputs = form.elements;
    for(var i=0; i < inputs.length; i++) {
        if (inputs[i].name != null && inputs[i].name != "") {
            out += inputs[i].name + "=";
            if (inputs[i].type == "Select") {
                out += inputs[i].options[inputs[i].options.selectedIndex];
            }
            else if (inputs[i].type == "checkbox") {
                if (inputs[i].checked) out += inputs[i].value;
            }
            else if (inputs[i].name == "endpoint") {
                out += encodeURIComponent(trim(inputs[i].value));
            }
            else {
                out += trim(inputs[i].value);
            }
            out += "&";
        }
    }

    return out
}

function showResults(resp) {
    try {
        logDebug("root: " + resp.responseXML.firstChild.tagName);
        if (resp.responseXML.firstChild.tagName == "html") {
            results = resp.responseXML.getElementById("results");
            if (results == null) 
                throw new Error("results missing results section!");
            oldresults = document.getElementById("results");
            if (oldresults == null) 
                throw new Error("page missing results section!");
            swapDOM(oldresults, results);
        }
        else {
            logDebug(resp.responseText);
            setStatusMessage("Problem getting results: ");
        }
    }
    catch (e) {
        logError("showResults: " + e.name+ ": " + e.message);
    }
    return true;
}

function doload() {
    if (loadurl != null) location.href = loadurl;
}
var loadurl = null;

function loadResults(resp) {
    logDebug("loadResults: " + resp.responseText);
    try {
        var status = evalJSONRequest(resp);
        if (! status.resultURL.match("^http://"))
            throw new Error("bad resultURL: " + session.sessionURL);

        location.href = status.resultURL;
        // window.open(status.resultURL);
        // loadurl = status.resultURL;
        // setTimeout(doload, 5000)
    }
    catch (e) {
        logError("loadResults: " + e.name+ ": " + e.message);
    }
    return true;
}





  -->
</script>

<!-- =======================================================================
  -  End Page Content
  -  ======================================================================= -->

<br /><br />

    </div>
</div>

	<div id="siteInfo">
		<table width="99%">
			<tr style="color:#005fa9;">
    <td><div align="center"><a href="http://esavo.esac.esa.int"><img src="http://registry.euro-vo.org/logo.gif" width="115" height="64" border="0"></a></div></td>
    <td><div align="center"><a href="http://www.us-vo.org"><img src="http://www.us-vo.org/images/NVO_100pixels.jpg" width="120" height="60" border="0"></a></div></td>

    <td><p class="tiny" align="center">Developed by ESAVO in the context of the EURO-VO AIDA project <br> using the DALValidater software source code from NVO, which was<br>
                                       developed with the support of the National Science Foundation under <br> Cooperative Agreement AST0122449 with The Johns Hopkins University.<br>
      </p></td>

    <td><div align="center"><a href="http://www.nsf.gov"><img src="http://www.us-vo.org/images/nsflogo_64x.gif" width="64" height="64" border="0"></a></div></td>
    <td><div align="center"><a href="http://www.nasa.gov"><img src="http://www.us-vo.org/images/nasa_logo_sm.gif" width="64" height="60" border="0"></a></div></td>
			</tr>
		</table>
	</div>
</div>
	</body>
</html>

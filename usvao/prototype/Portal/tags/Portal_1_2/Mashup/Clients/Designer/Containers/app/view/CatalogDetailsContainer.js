/*
 * File: app/view/CatalogDetailsContainer.js
 * Date: Tue Sep 20 2011 12:05:21 GMT-0400 (Eastern Daylight Time)
 *
 * This file was generated by Ext Designer version 1.2.0.
 * http://www.sencha.com/products/designer/
 *
 * This file will be generated the first time you export.
 *
 * You should implement event handling and custom methods in this
 * class.
 */

Ext.require('Mvpc.view.GenericDetailsContainer');
Ext.require('Mvp.util.SearchBox');

Ext.define('Mvpc.view.CatalogDetailsContainer', {
    extend: 'Mvpc.view.ui.CatalogDetailsContainer',

    initComponent: function () {
        var me = this;
        me.callParent(arguments);
    },

    constructor: function (config) {
        this.callParent(arguments);    //set up basic Container class variables

        this.searchText = config.searchText;
        var toolbar = this.getComponent('summaryPanel').getComponent('detailsToolbar');
        var loadButton = toolbar.getComponent('loadButton'),
            downloadButton = toolbar.getComponent('downloadButton'),
            searchField = Ext.create('Mvp.util.SearchBox', {
                itemId: 'searchField',
                fieldLabel: 'Refine Search',
                emptyText: 'Enter object name or RA and Dec'
            });
        toolbar.add([{ xtype: 'tbseparator' }, searchField]);
        var summaryPanel = this.getComponent('summaryPanel');

        var record = config.record;
        this.searchAction = '';
        var dataType = 'Unknown';
        var categoryString = record.get('categories');
        if (categoryString) {
            if (categoryString.match('Images')) {
                dataType = 'Images';
                this.searchAction = 'searchGenericSiap';
            } else if (categoryString.match('Catalog')) {
                dataType = 'Catalog';
                this.searchAction = 'searchGenericCone';
            }
        }

        loadButton.setHandler(this.loadRecords, this);
        downloadButton.setHandler(this.downloadRecords, this);
        searchField.on('searchInitiated', this.doSearch, this);
        var resourceInfoItems = [
            {
                xtype: 'label',
                html: record.get('description')
            }, {
                fieldLabel: 'Publisher',
                value: record.get('publisher')
            }, {
                fieldLabel: 'Website',
                value: Mvp.util.Util.createLink(record.get('referenceURL'))
            }, {
                fieldLabel: 'Record Count',
                value: record.get('hits')
            }, {
                value: '&nbsp;'
            }, {
                value: '&nbsp;'
            }
            ]

        var resourceInfo = {    //set up header portion of record
            xtype: 'fieldset',
            title: 'Resource Information',
            defaultType: 'displayfield',
            items: resourceInfoItems,
            width: 350
        };
        //record.set('accessURL', '<ignore>');    // exclude the basic search URL from the generic record
        summaryPanel.getComponent('summaryContainer').add(resourceInfo);
        // dump contents into lower panel
        var detailsPanel = this.getComponent('detailsPanel');
        var c = Ext.create('Mvpc.view.GenericDetailsContainer', { record: record, grid: config.grid,
            fieldOverrides: { accessURL: { autolink: false} }
        });
        detailsPanel.add(c);
    },

    loadRecords: function () {
        var accessURL = this.record.get('tableURL');
        var title = this.record.get('title'),
            shortTitle = this.searchText + ': ' + this.record.get('shortName');
        var capability = this.record.get('capabilityClass');
        var identifier = this.record.get('identifier');
        if (identifier.match('^ivo://mast.stsci/stpr')) {
            this.searchScope.loadStpr(accessURL, shortTitle, title);
            this.searchScope.detailsWindow.close();
        }
        else if (accessURL) {
            (capability && capability == 'SimpleImageAccess') ? this.searchScope.loadGenericSiap(accessURL, shortTitle, title) : this.searchScope.fullSearchVoTable(accessURL, shortTitle, title);
            this.searchScope.detailsWindow.close();
        } else {
            alert("Data table unavailable for " + title);
        }
    },

    downloadRecords: function () {
        var url = this.record.get('tableURL');
        Mvp.util.Exporter.downloadUrl(url);
    },

    doSearch: function () {
        var url = this.record.get('accessURL'),
            searchText = this.query('#searchField')[0].value;
        var title = this.record.get('shortName') + ": " + searchText;

        if (url) {
            url = url.replace(/amp;/gi, '');
        }
        var extraArgs = [url, title];
        extraArgs.summaryDisplay = Ext.create('Ext.form.field.Display', {
            fieldLabel: ' ',
            labelSeparator: '',
            labelWidth: 100,
            value: ' '
        });
        var args = [searchText, this.searchAction, extraArgs];

        // Call the main app's search routine.
        Ext.callback(this.searchScope.doSearch, this.searchScope, args);
    }
});

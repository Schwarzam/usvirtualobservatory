var canvasport={getDrawing:function(a){return a.getContext("2d");},_fillText:function(b,d,a,e,c){if(b.fillText){b.font=c;b.fillText(d,a,e);}else{if(b.mozDrawText){b.save();b.mozTextStyle=c;b.translate(a,e);b.mozDrawText(d);b.restore();}}},_strokeText:function(b,d,a,e,c){if(b.strokeText){b.font=c;b.strokeText(d,a,e);}else{if(b.mozDrawText){b.save();b.mozTextStyle=c;b.translate(a,e);b.mozDrawText(d);b.restore();}}},drawText:function(b,f,a,g,d,c,e){if(d){b.save();b.translate(a,g);b.rotate(270*Math.PI/180);this._fillText(b,f,0,0,c);if(e){this._strokeText(b,f,0,0,c);}b.restore();}else{this._fillText(b,f,a,g,c);if(e){this._strokeText(b,f,a,g,c);}}},measureText:function(a,b){return(a.measureText?a.measureText(b).width:(a.mozMeasureText?a.mozMeasureText(b):100));},drawImage:function(m,f,b,a,d,k,h,g,c,l){try{var i=f[0];m.drawImage(i,b,a,d,k,h,g,c,l);}catch(j){alert("Problem with canvas "+j.message);}},drawImageslice:function(a,d,g){try{var c=d;var b=g;if(this.spriteimage!=null){a.drawImage(this.spriteimage,c.x,0,c.w,c.h,b.x-Math.floor(c.w/2),b.y-Math.floor(c.h/2),c.w,c.h);}}catch(f){llh.error("Problem with canvas "+f.message);}},roundedRect:function(k,h,g,a,j,f,m,c,e,l){var b=7;var d=(j-b)/2;function i(n){return(c?n+h:a+h-n);}k.beginPath();k.moveTo(i(0),g+e);k.lineTo(i(0),g+d-b/2);k.quadraticCurveTo(i(-h),g+d-b/2,f.x,f.y);k.quadraticCurveTo(i(-h),g+d+b/2,i(0),g+d+b/2);k.lineTo(i(0),g+j-e);k.quadraticCurveTo(i(0),g+j,i(e),g+j);k.lineTo(i(a-e),g+j);k.quadraticCurveTo(i(a),g+j,i(a),g+j-e);k.lineTo(i(a),g+e);k.quadraticCurveTo(i(a),g,i(a-e),g);k.lineTo(i(e),g);k.quadraticCurveTo(i(0),g,i(0),g+e);k.closePath();k.strokeStyle=(l&&l.color?l.color:"#723F3F");k.fillStyle=(l&&l.bkcolor?l.bkcolor:"rgba(255, 255, 255, 1.0)");k.fill();k.stroke();},customiseBubble:function(c,d,b,f,e){var a=d.position();a.top+=parseInt(d.css("padding-top").replace("px",""));a.left+=parseInt(d.css("padding-left").replace("px",""));var h=5;c.clearRect(0,0,c.canvas.width,c.canvas.height);var g={x:(f?0:c.canvas.width),y:(b?0:c.canvas.height)};this.roundedRect(c,a.left-h,a.top-h,d.width()+2*h,d.height()+2*h,g,b,f,15,e);},hitTest:function(j,k,h,b,m,a){var g=j.canvas.width;var f=j.canvas.height;if(a){if((k<0)||(h<0)||(k+b>g)||(h+m>f)){return true;}}var l=j.getImageData(k,h,b,m);var d=l.data;for(var e=0,c=d.length;e<c;e+=4){if(d[e]!=255){return true;}}return false;}};function on_mousemove(a){if(cloud.getBox(a.clientX,a.clientY)){document.body.style.cursor="pointer";}else{document.body.style.cursor="";}}function on_click(a){cloud.on_click(a.clientX,a.clientY);}var metaaps={};var textcloudNumTries=10;metaaps.nebulos=function(a){this.canvas=a;this.opacityvalue=1;this.notestboxes=true;this.stroke=true;this.screenportion=0.9;this.fillstyle={red:0,green:0,blue:0};this.strokestyle="rgba(0, 0, 0, 0.1)";this.shaded=true;this.multicolor=false;this.boxes=[];this.running=false;this.restarthandler=null;this.directions=["n","s","ne","se","nw","sw"];this.fontfamily="serif";this.minWordSize=4;this.symbols=[".","!",":","*","?","+","'",'"',",",";","#","%","&","/","=","[","]","{","}","- ","_","(",")","\r","\t","\n"];this.measureText=function(e,d,c,b){if(c){return{height:canvasport.measureText(b,e),width:d};}else{return{width:canvasport.measureText(b,e),height:d};}};this.findPosition=function(e,c,b,g,l){for(var f=0;f<150;f+=3){var j=this.directions[g%this.directions.length];var i=this.getPosition(e,j,f);if(l.getImageData&&this.notestboxes){if(canvasport.hitTest(l,i.x,(b?i.y-c.height:i.y),c.width,c.height,true)==false){return i;}}else{var k={x:i.x,y:(b?i.y-c.height:i.y),width:c.width,height:c.height};for(var d=0;d<this.boxes.length;d++){var h=this.boxes[d];if(h.x<k.x+k.width&&k.x<h.x+h.width&&h.y<k.y+k.height&&k.y<h.y+h.height){break;}}if(d==this.boxes.length){return i;}}g++;}return null;};this.getPosition=function(c,d,b){var e=c;switch(d){case"n":e.y-=b;break;case"s":e.y+=b;break;case"e":e.x+=b;break;case"w":e.x-=b;break;case"ne":e.y-=b;e.x+=b;break;case"se":e.y+=b;e.x+=b;break;case"nw":e.y-=b;e.x-=b;break;case"sw":e.y+=b;e.x-=b;break;}return e;};this.extendBounds=function(c,b){c.minx=Math.min(b.x,c.minx);c.miny=Math.min(b.y,c.miny);c.maxx=Math.max(b.x+b.width,c.maxx);c.maxy=Math.max(b.y+b.height,c.maxy);};this.drawText=function(f,e,b,d,c){canvasport.drawText(c,f,b.x,b.y,d,e,this.stroke);};this.getOpacityvalue=function(c,b){if(this.shaded==false){return this.opacityvalue;}else{return c/b*0.6+0.3;}};};metaaps.nebulos.prototype={setSymbols:function(a){this.symbols=a;},setMinWordSize:function(a){this.minWordSize=a;},restart:function(a){this.restarthandler=a;},setText:function(a){this.textlist=this.generateTextlist(a);},setTextList:function(a){this.textlist=a;},setFontFamily:function(a){this.fontfamily=a;},clear:function(){var b=this.canvas;var a=canvasport.getDrawing(b);a.clearRect(0,0,b.width,b.height);},draw:function(w,f){if(w){if(typeof w=="string"){this.setText(w);}else{this.setTextList(w);}}this.boxes=[];this.running=true;this.restarthandler=null;var e=this.canvas;var r=canvasport.getDrawing(e);r.clearRect(0,0,e.width,e.height);r.fillStyle="rgba(255, 255, 255, 1)";r.fillRect(0,0,e.width,e.height);var s={x:e.width/2,y:e.height/2};var h={minx:s.x,miny:s.y,maxx:s.x,maxy:s.y};function p(D,B){var x={x:(h.maxx+h.minx)/2,y:(h.maxy+h.miny)/2};var z={x:x.x-B.width/2,y:(a?x.y+B.height/2:x.y-B.height/2)};var A=h.maxx-h.minx;var i=h.maxy-h.miny;var D="";if(x.y>s.y){D+="n";}else{D+="s";}if(x.x>s.x){D+="w";}else{D+="e";}var C=(Math.random())*A/3.5;var y=(Math.random())*i/2.2;switch(D){case"ne":return{x:z.x+C,y:z.y-y};break;case"nw":return{x:z.x-C,y:z.y-y};break;case"se":return{x:z.x+C,y:z.y+y};break;case"sw":return{x:z.x-C,y:z.y+y};break;}return null;}var l=this.directions;var t=this;var a=0;this.textlistcount=0;r.textBaseline="top";r.strokeStyle=this.strokestyle;r.textAlign="left";var m={area:0};var o=10;var d=0.75;var n=this.textlist;for(var u=0;u<n.length;u++){var v=n[u];var c=v.weight*o;r.font=c+"px "+t.fontfamily;var k=t.measureText(v.text,c,a,r);m.area+=k.width*k.height;}var q=Math.sqrt((e.width*e.height)/m.area*t.screenportion)*o;var g=q*n[0].weight;var b="Could not place: ";function j(){var D=n[t.textlistcount++];var y=D.weight;var G=Math.floor(y*q);r.font=G+"px "+t.fontfamily;r.textBaseline="top";var B=t.getOpacityvalue(G,g);r.fillStyle="rgba("+t.fillstyle.red+", "+t.fillstyle.green+", "+t.fillstyle.blue+", "+B+")";r.strokeStyle=t.strokestyle;r.textAlign="left";var F=D.text;a=0;var z=t.measureText(F,G,a,r);try{for(var i=0;i<textcloudNumTries;i++,z=t.measureText(F,G,a,r)){if(z.width>t.canvas.width||i>textcloudNumTries/3){D.weight=Math.max(0.5,D.weight-d);G=Math.floor(D.weight*q);r.font=G+"px "+t.fontfamily;z=t.measureText(F,G,a,r);}if(z.width<=t.canvas.width){var C=Math.floor(Math.random()%l.length);var E=l[C];var x=t.findPosition(p(E,z),z,a,C,r);if(x!=null){t.drawText(F,r.font,x,a,r);t.boxes.push({x:x.x,y:(a?x.y-z.height:x.y),width:z.width,height:z.height,position:x,text:F,vertical:a,font:r.font,fillstyle:r.fillstyle,fontSize:G});break;}}}if(i==textcloudNumTries){console.warn("TextCloud: "+b+" "+F+" ("+i+" tries)");}t.extendBounds(h,{x:x.x,y:(a?x.y-z.height:x.y),width:z.width,height:z.height});}catch(A){}if(t.restarthandler!=null){setTimeout(function(){t.restarthandler();},500);t.running=false;return;}if(t.textlistcount<n.length){setTimeout(j,1);}else{t.running=false;}}setTimeout(j,1);},redraw:function(){var c=this.canvas;var b=this;var a=canvasport.getDrawing(c);a.clearRect(0,0,c.width,c.height);a.textBaseline="top";a.strokeStyle=b.strokestyle;a.textAlign="left";var g=b.boxes[0].fontSize;for(var d=0;d<b.boxes.length;d++){var f=b.boxes[d];var e=b.getOpacityvalue(f.fontSize,g);a.fillStyle="rgba("+b.fillstyle.red+", "+b.fillstyle.green+", "+b.fillstyle.blue+", "+e+")";b.drawText(f.text,f.font,f.position,f.vertical,a);}},generateTextlist:function(j){var h=[];var c=j+" ";c=c.toLowerCase();for(var f=0;f<this.symbols.length;f++){var k=this.symbols[f];c=c.replace(new RegExp("\\"+k,"g")," ");}var d=c.split(" ");var g={};var e=this.minWordSize;for(var f=0;f<d.length;f++){var k=d[f];if(k.length>e){if(g[k]){g[k]++;}else{g[k]=1;}}}for(var a in g){if(!isNaN(g[a])){h.push({text:a,weight:g[a]});}}function b(l,i){if(l.weight<i.weight){return 1;}if(l.weight>i.weight){return -1;}return 0;}h.sort(b);h.splice(200,Math.max(0,h.length-200));return h;},getBox:function(a,d){for(var b=0;b<this.boxes.length;b++){var c=this.boxes[b];if(c.x<=a&&c.x+c.width>=a&&c.y<=d&&c.y+c.height>=d){this.currentBox=c;return c;}}this.currentBox=null;return null;},on_click:function(a,c){if(this.currentBox){var b=this.currentBox.text;}}};
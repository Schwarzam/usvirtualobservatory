/*
 * File: app/view/DatascopeDetailsContainer.js
 * Date: Tue Sep 20 2011 12:05:21 GMT-0400 (Eastern Daylight Time)
 *
 * This file was generated by Ext Designer version 1.2.0.
 * http://www.sencha.com/products/designer/
 *
 * This file will be generated the first time you export.
 *
 * You should implement event handling and custom methods in this
 * class.
 */

Ext.define('Mvpc.view.DatascopeDetailsContainer', {
    requires: ['Mvpc.view.GenericDetailsContainer',
               'Mvp.util.SearchBox',
               'Mvp.util.Exporter',
               'Mvp.util.Util'
               ],
    extend: 'Mvpc.view.ui.DatascopeDetailsContainer',

    initComponent: function () {
        var me = this;
        me.callParent(arguments);
    },

    constructor: function (config) {
        this.callParent(arguments);    //set up basic Container class variables

        this.searchText = config.searchText;
        var toolbar = this.getComponent('summaryPanel').getComponent('detailsToolbar');
        this.record = config.record;
        this.refineSearchAction = '';
        var dataType = 'Unknown';

        var capability = this.record.get('capabilityClass');
        if (capability && capability == 'ConeSearch') {
            this.refineSearchAction = 'Cone';
        } else if (capability && capability == 'SimpleImageAccess') {
            this.refineSearchAction = 'Siap';
        } else if (capability && capability == 'SimpleSpectralAccess') {
            this.refineSearchAction = 'Ssap';
        }

        var loadButton = toolbar.getComponent('loadButton'),
            downloadButton = toolbar.getComponent('downloadButton'),
            searchField = Ext.create('Mvp.util.SearchBox', {
                itemId: 'searchField',
                fieldLabel: 'Search This Resource',
                labelWidth: 125,
                emptyText: 'Enter object name or RA and Dec',
                width: 360
            });
        if (this.refineSearchAction !== '') {
            toolbar.add(searchField);
        }
        var summaryPanel = this.getComponent('summaryPanel');

        loadButton.setHandler(this.loadRecords, this);
        downloadButton.setHandler(this.downloadRecords, this);
        searchField.on('searchInitiated', this.doSearch, this);
        var resourceInfoItems = [
            {
                xtype: 'label',
                html: this.record.get('description')
            }, {
                fieldLabel: 'Publisher',
                value: this.record.get('publisher')
            }, {
                fieldLabel: 'Website',
                value: Mvp.util.Util.createLink(this.record.get('referenceURL'))
            }, {
                fieldLabel: 'Record Count',
                value: this.record.get('hits')
            }, {
                value: '&nbsp;'
            }, {
                value: '&nbsp;'
            }
        ];

        var resourceInfo = {    //set up header portion of this.record
            xtype: 'fieldset',
            title: 'Resource Information',
            defaultType: 'displayfield',
            items: resourceInfoItems,
            width: 415,
            margin: '0 0 0 10'
        };
        summaryPanel.getComponent('summaryContainer').add(resourceInfo);
        // dump contents into lower panel
        var detailsPanel = this.getComponent('detailsPanel');
        var c = Ext.create('Mvpc.view.GenericDetailsContainer', {
            controller: this.controller = config.controller,
            record: this.record,
            fieldOverrides: { accessURL: { autolink: false} }
        });
        detailsPanel.add(c);
    },

    loadRecords: function(obj, e, config) {
        Mvp.custom.FullSearch.loadRecords(this.record, this.controller);
    },

    downloadRecords: function () {
        var url = this.record.get('tableURL');
        Mvp.util.Exporter.downloadUrl(url);
    },

    doSearch: function () {
        var url = this.record.get('accessURL'),
            searchText = this.query('#searchField')[0].value;
        var title = this.record.get('shortName') + ": " + searchText;
        var description = this.record.get('title') + ' searched at ' + searchText;
        
        url = Mvp.util.Util.fixAccessUrl(url);

        var args = { url: url, inputText: searchText,
            title: title, description: description
        };

        var searchParams = Mvp.search.SearchParams.getSearch(this.refineSearchAction);
        searchParams.downloadEnabled = true;
        Mvp.gui.DetailsWindow.closeDetailsWindow();
        this.controller.invokeSearch(args, searchParams);
    }
});
